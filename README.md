# Telegram-бот

## Обзор
Персональный Telegram-бот, который подключает групповой чат к LLM и поддерживает несколько LLM‑провайдеров через JSON‑контракты в `llm_providers/`. Бот привязан к одному владельцу и реагирует только на сообщения этого пользователя в группе.

## Как работает
- Добавьте бота в группу.
- В группе напишите сообщение и упомяните роль (например, `@analyst`). Если `routing.require_bot_mention=true`, упомяните также самого бота.
- Если для провайдера требуются дополнительные данные (`user_fields`), бот запросит их в личке.
- Бот отправляет запрос в LLM и отвечает в группе.
- Настройка ролей и параметров выполняется в личных сообщениях через `/groups`.

## Ключевые свойства
- Один бот = один владелец (`owner_user_id`). Сообщения других участников игнорируются.
- Сессии создаются по связке `(user, group, role)`. Контексты изолированы.
- Роли задаются для каждой группы отдельно и настраиваются через приватное меню.
- LLM‑провайдеры описываются JSON‑конфигами: добавить/удалить провайдера = добавить/удалить файл.

## Требования
- Python 3.9+
- Токен Telegram-бота (BotFather)
- Доступ к LLM API (в зависимости от выбранного провайдера)

## Установка
```bash
python -m venv .venv
source .venv/bin/activate
python -m pip install -r requirements.txt
```

## Конфигурация
1) Скопируйте пример конфига:
```bash
cp config.example.json config.json
```

2) Заполните поля (нужно заполнить только значения `REPLACE_ME`).

### Верхний уровень
- `telegram_bot_token` — токен бота из BotFather
- `database_path` — путь к sqlite базе (по умолчанию `./bot.sqlite3`)
- `encryption_key` — Fernet‑ключ для шифрования токенов
- `owner_user_id` — ваш Telegram user_id (бот отвечает только вам)
- `routing.require_bot_mention`:
  - `false` — триггер по `@role` без упоминания бота
  - `true` — требуется упоминание бота

Сгенерировать Fernet‑ключ:
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```
Если нужно, установите `cryptography`:
```bash
pip install cryptography
```

### Раздел llm
- `llm.timeout_sec` — таймаут запросов
Прочие параметры LLM описываются в `llm_providers/*.json`.

### Раздел formatting
- `formatting.mode` — форматирование ответов: `markdown` или `html`.
- `formatting.allow_raw_html` — отправлять «сырой» HTML от LLM (если Telegram API не примет — бот отправит экранированный текст). Актуально для `mode=html`.

## Запуск
```bash
python bot.py
```

## Настройка в группе
- Добавьте бота в группу.
- Напишите сообщение с упоминанием роли (например, `@analyst`).
- Если для провайдера нужны данные — бот запросит их в личке.

## Настройка в личке (`/groups`)
- Откройте личный чат с ботом и выполните `/groups`.
- Выберите группу, затем роль и нужный параметр.
- Доступны:
  - системный промпт
  - инструкция к сообщениям
  - инструкция для реплаев
  - выбор LLM‑модели
  - переименование роли
  - сброс сессии / удаление роли
  - добавление новой роли или копирование существующей

## Форматирование запроса в LLM
Если есть инструкции или реплай‑контекст, формируется структура:

```
#GENERAL_INSTRUCTIONS
<инструкция к каждому сообщению>

#CONTEXT_INSTRUCTIONS
<инструкция для реплаев>

#CONTEXT
<текст сообщения, на которое ответили>

#USER_REQUEST
<сообщение пользователя>
```

Если нет инструкций и контекста, отправляется только текст пользователя.

## Примечания
- Команды доступны только в личном чате. В группе команды не отображаются и не обрабатываются.
- При удалении и повторном добавлении в группу бот становится активным автоматически.

## Диагностика
- Если бот не реагирует в группе, проверь `owner_user_id` и `routing.require_bot_mention`.
- Если не приходят логи из группы, убедись, что бот получает апдейты (polling).
- При таймаутах LLM проверь доступность API и состояние LLM‑сервера.

## Документация
- Навигация по разделам: `docs/index.md`
- Провайдеры LLM: `docs/providers.md`
- Плагины: `docs/plugins.md`
